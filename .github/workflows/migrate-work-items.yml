name: Migrate Work Items

on:
  workflow_dispatch:
    inputs: 
      ado-org:
        description: 'ado-org'
        required: true
        default: 'jjohanning0798'
      ado-project:
        description: 'ado-project'
        required: true
        default: 'PartsUnlimited'
      ado_area_path:
        description: 'ADO area path to migrate - uses the UNDER operator'
        required: true
        default: 'migrate'
      ado_migrate_closed_workitems:
        description: 'Migrate closed work items'
        required: true
        type: boolean
        default: 'true'
      ado_production_run:
        description: tag migrated work items with migrated-to-github and add discussion comment
        required: true
        type: boolean
        default: 'true'
      gh-org:
        description: 'gh-org'
        required: true
        default: 'joshjohanning-org'
      gh-repo:
        description: 'gh-org'
        required: true
        default: 'migrate-ado-workitems'
      gh_update_assigned_to:
        description: 'Update Assigned To'
        required: true
        type: boolean
        default: 'true'
      gh_assigned_to_user_suffix:
        description: 'EMU suffix'
        required: true
        default: '_corp'
      gh_add_ado_comments:
        description: 'Add ADO Comments'
        required: true
        type: boolean
        default: 'true'

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@main
      
      - uses: tibdex/github-app-token@v1
        id: get_installation_token
        with: 
          app_id: 179484
          installation_id: 23995058
          private_key: "-----BEGIN PRIVATE KEY----- MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCc4iF8CSBXfqwdPOXzKLW1DQrSVPF1aoiaRQO7rWIxyflVfJXoQ0VFkzZ4vpOnwnWiypX2ObG1FqFsV8rD5Mbe1fE7AER6k5IXE4Xe++tGIdpk4G0XMBadIqC/SqJawMs8EY2MwKTrdCexbV0Gnn+Wy0R8W+nw4TrZWhjpXyi+9cGC+AUDgj3kDsDFFmPDqmC+TNtyKYw1WpSwQivZZ3FmdKxAcEoYkb5wPbwu++pXrY0anTD4AQ6PJn242+XzAnH1IUuZC1dkYpZryFVhTfURngsYYOVumFbhCJjjx2zLHbsaDEOlpf967gy32TzKeriJC8QCDs4RjfnXU8yEu0V7AgMBAAECggEAAl+bcRR0RE6azQBwXCroANq3KLJ3Srb3ZRoZMdwwKZ+sIYJ2hCKMaD6Pauk7M6UKAZH+DdEWoq46d/imDSunZJSpByL8ZjxYT/gQJOz7xL5bXv5UOC8WkH8HHo3DAgt7p6d+VDxP4m4J8bG9YA3C0WW23gjH88h8ivBFgzZY1/a6xhs9bcbNOhUGeGoITBl4gaaQptzGer31Otac8bQ0V7s5dlahohfdzVKme0+U3/82cYq7s/wygVaAXxUhxiCjOjeQ0Zr3cUU1GyXRbC79FAVigJ7URh0g/IhHnGOkH+1opIg+V7gYy0IPkCP9QC6I8y+UZcPxTJ/DnLcqv2bJXQKBgQDaeXQahjJsRrGolaVJjgt28kMH/OQvB16AuRG5iBX1Rd4WXSmLb3VJ9SesxaSx90b+xbMeZGmJ/hxNX0ZFZ9mXMtMGEVJLUSV46QwHvAwOFWfhim0N1bXqzTFAX5FXaQ/MprU9DEezURPt1iDy5BF0HbvxlXJM/2W6JI21Iau+ZwKBgQC31HPmGI5uHFSPfKQrmoFzpEIIy0TCYzBeou3jdEPq6M0Du7+WUwDa72pIOW3ks4RDhMOJzltcaIBjUlqqrOB36HFgd6Qe/cUWMIUpHE7fn8mV3aYnIskX3Usb7Rox5VZ3TxfM5vixzPCAK0q2jksGRDAK4To+kY9WKqIVLLOrzQKBgAMBxO1Qh4Uh+/P8C0hV4iaC8xU7D9Dt4wkWgv3wt4ymp4XbRmUa5Zxc+WzRU5D3fEypX+u9Kg6yJqWR+B+gbEg+dNUSi/VpaoCdhILevbO767AY/aNBG73dkR33ssJnOcZxTPFIJ/x50zJkzhNJvEvC1QFgMzCIG1hShHjHu9tlAoGAE94fRJAE3LutG/DhoWDKeuAWzvKBFO05bhD32uxW5s2QUsX419tSrVbQysuCKASK1+1CYONvllYpAhMFf4q9m9gAYOetUjglE9fcnGvVzm9rjwnsijBFQZIGKxd+DER4Ct7+eIPB/x1iJMgJBB/u1deKxbI/5EFBF5P1/ondRUUCgYAObLjJ8jL3WvOPrn2PIlNw1nLezZ/XjwzHQyc4aaquwXtIfvW9zpcs1NpstFPA9iv61THviLAp/VIB/d/yoMdA9dwN2qyVt/jk89x2qSxLC6L8ZBhZMaBe00ROMospomIyje/jo6pYoXpJUn7ls6Nyn5aUYGHc70Qq7S/j9NjY2g== -----END PRIVATE KEY-----"
      
      - name: run migration
        shell: pwsh
        run: |
          # run migration script
          
          # cleaning up bools
          $ado_migrate_closed_workitems=$false
          $ado_production_run=$false
          $gh_update_assigned_to=$false
          $gh_add_ado_comments=$false
          
          if("${{ github.event.inputs.ado_migrate_closed_workitems }}" -eq "true") {
            $ado_migrate_closed_workitems=$true
          }

          if("${{ github.event.inputs.ado_production_run }}" -eq "true") {
            $ado_production_run=$true
          }

          if("${{ github.event.inputs.gh_update_assigned_to }}" -eq "true") {
            $gh_update_assigned_to=$true
          }
          
          if("${{ github.event.inputs.gh_add_ado_comments }}" -eq "true") {
            $gh_add_ado_comments=$true
          }
          
          ./ado_workitems_to_github_issues.ps1 -ado_pat "${{ SECRETS.ADO_PAT }}" -ado_org "${{ github.event.inputs.ado-org }}" -ado_project "${{ github.event.inputs.ado-project }}" -ado_area_path "${{ github.event.inputs.ado_area_path }}" -ado_migrate_closed_workitems $ado_migrate_closed_workitems -ado_production_run $ado_production_run -gh_pat "${{ steps.get_installation_token.outputs.token }}" -gh_org "${{ github.event.inputs.gh-org }}" -gh_repo "${{ github.event.inputs.gh-repo }}" -gh_update_assigned_to $gh_update_assigned_to -gh_assigned_to_user_suffix "${{ github.event.inputs.gh_assigned_to_user_suffix }}" -gh_add_ado_comments $gh_add_ado_comments
          
